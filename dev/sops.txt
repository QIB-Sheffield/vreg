SOPs for maintainers
********************

Building a virtual environment
------------------------------

Clone dcmri package locally

cd to dcmri top folder

On windows:
>>> py -3 -m venv .venv           # create virtual environment
>>> .venv/Scripts/activate        # activate virtual environment

Then select the Python interpreter in the .venv folder. In VSCode:
View > Command Palette > Python select interpreter -> enter interpreter path 
(.venv/Scripts/python.exe)


Installation
------------

Install dcmri from source:

>>> pip install -e path\to\dcmri

Install tests requirements:

cd to dcmri/tests
>>> pip install -r requirements.txt

Install docs requirements:

cd to dcmri/docs
>>> pip install -r requirements.txt

Install dev requirements:

cd to dcmri/dev
>>> pip install -r requirements.txt

To leave:
>>> deactivate


Enforce PEP8
------------

cd to /dcmri top folder

To fix a single file
>>> autopep8 src/dcmri/file.py --in-place

To fix the whole project
>>> autopep8 src/dcmri --recursive --in-place --pep8-passes 2000 --verbose

Check any remaining isues and fix manually
>>> pycodestyle src/dcmri --ignore=E501

Note agressive option - dangerous - may need debugging. Use carefully and test 
after changing
>>> autopep8 src/dcmri/file.py --in-place --aggressive



Run test suite and check test coverage
--------------------------------------

cd to /dcmri top folder
>>> pytest --cov=dcmri --cov-report term-missing

To run a specific file (eg. test_utils) only, do:
>>> pytest tests/test_utils.py --cov=dcmri --cov-report term-missing


Check tests in docstrings
-------------------------

To test file.py, cd to directpory of file.py, then do:
>>> pytest --doctest-modules file.py

To insert the expected test results, do:
>>> pytest --doctest-modules file.py --accept


Build documentation locally
---------------------------
cd to docs
>>> ./make html

To see the docs, open: dcmri/docs/build/html/index.html

To make all autogenerated documentation from scratch, first delete all auto-generated content:

- delete docs/build
- delete all folders inside docs/source/generated/
- run docs/source/make_animations.py


Building release notes
----------------------
- Get a personal token on https://github.com/settings/tokens (does not need any permissions)
- Save the token in the environment variable GH_TOKEN. On windows:
>>> $env:GH_TOKEN='token'
- Build the changelog from current version to current dev. For instance:
>>> changelist QIB-Sheffield/dcmri 0.6.2 dev --format rst
- Copy-paste the terminal output in an .rst file and save it in docs/source/releases
- Edit the content of the file manually as needed
- Add an entry in the index of docs/source/releases


Creating a new release (from a fork)
------------------------------------

= Enforce PEP8 (see above)
- Run the test suite in a clean environment (see above) and check test 
  coverage (see above)
- Add any new contributors to the teams.inc file (About)
- Update the version number in the below locations, push to dev and check that 
  all tests pass. Fix issues if not.
    - pyproject.toml
    - docs/source/conf.py
- Build release notes (see above), build and check the documentation, and push 
  changes to dev. 
- Merge the dev branch with the main branch. 
  Check that the documentation builds OK. Check README.
- Set the website back to dcmri.org: Go to 
  https://github.com/dcmri/dcmri/settings/pages and enter 
  https://dcmri.org as custom domain.
- Create a release on github, with the main branch as target. 
- Create a release on PyPI (see below)
- v1.0 and onwards: Create a versioned release on Zenodo


Creating a PyPi release
-----------------------

In the terminal, cd to the /dcmri directory, and:

>>> python -m build
>>> twine upload dist/*

When prompted for user name, enter __token__

As password paste the API token generated in PyPi dcmri repository 
settings (https://pypi.org/manage/project/dcmri/settings/). 
Note: Paste with Ctrl-V does not work in Windows. Use Edit > Paste via the menu.

